---
layout: post
author: joonwan jeon
tags: [database, mysql]
category: database
---

# 두 테이블간 연관관계를 맺는 방법

## 들어가며

데이터베이스르 처음 설계할 때, "모든 정보를 하나의 테이블에 넣으면 안될까?" 하는 생각을 해본 적이 있을 것입니다. 

예를 들어 쇼핑몰에서 회원 정보와 주문 정보를 다음처럼 하나의 테이블에 저장하면 어떻게 될까요?

| user_id | name | email | order_id | order_date | total_amount |
|---------|------|-------|----------|------------|--------------|
| 1 | 홍길동 | hong@example.com | 101 | 2024-01-15 | 50000 |
| 1 | 홍길동 | hong@example.com | 102 | 2024-01-20 | 30000 |
| 1 | 홍길동 | hong@example.com | 103 | 2024-02-01 | 25000 |

문제점은 다음과 같습니다.

- 홍길동의 이름과 이메일이 주문 건수만큼 중복되어 저장
- 이메일을 수정하기 위해서 모든 행을 찾아 수정
- 주문 없는 회원은 저장할 수 없음
- 데이터 붏일치 확률 상승

이러한 문제를 해결하기 위해서 **테이블을 분리**하고, **연관관계를 맺어** 관리합니다.

## 연관관계 종류

### 1 : N 관계 (One to Many)

가장 흔하고 중요한 관계 입니다.

한쪽 테이블의 하나의 레코드와 다른 테이블의 여러 레코드가 연관관계를 맺는 구조입니다. 실생활에서 다음과 같은 예시가 있습니다.

- 한명의 회원은 여러개의 주문을 할 수 있음
- 한개의 카테고리에는 여러개의 상품이 존재

### 1 : 1 관계 (One to One)

특정 한 테이블의 하나의 레코드가 다른 테이블의 단 하나의 레코드와 연관관계를 맺는 구조입니다. 실생활에서 다음과 같은 예시가 있습니다.

- 회원과 회원 상세 정보
- 직원과 좌석 

### N : M 관계 (Many to Many)

복잡한 관계로 교차 테이블을 이용해 1 : N, N : 1 관계로 풀어야 합니다. 
실생활에서 다음과 같은 예시가 있습니다.

- 학생 - 수업
- 주문 - 상품

## 외래키란?

외래키는 한 테이블의 칼럼이 다른 테이블의 기본키를 참조하는 것입니다. 역할은 다음과 같습니다.

- 연결 고리 : 두 테이블을 논리적으로 연결합니다.
- 참조 무결성 : 존재하지 않는 데이터를 참조하는 것을 방지합니다.
- 데이터 일관성 : 관련 데이터 간의 일관성을 유지합니다.

# 실습 : 회원과 주문 테이블 연관관계 맺기

이제 실제로 두 테이블 간 연관관계를 맺어보겠습니다.

## 전체 구조 이해하기

우리가 만들 구조는 다음과 같습니다.

```
users (부모)                orders (자식)
--------------              -----------------
user_id (PK) <──────────── user_id (FK)
email                       order_id (PK)
name                        order_date
created_at                  total_amount
                            status
```

- 한명의 회원은 여러개의 주문을 할 수 있습니다. 즉  One To Many 관계 입니다.
- orders.user_id 는 users.user_id 를 참조합니다.

## 부모 테이블 생성 

먼저 참조될 테이블인 users 를 생성합니다.

```sql
CREATE TABLE USERS (
    user_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

- user_id 가 PRIMARY KEY 이므로 다른 테이블에서 이를 참조할 수 있습니다.

## 자식 테이블 생성 

이제 users 를 참조하는 orders 테이블을 생성합니다.

```sql
CREATE ORDERS (
    order_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(12, 2) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',

    CONSTRAINT fk_orders_user
        FOREIGN KEY (user_id),
        REFERENCES users(user_id),
        ON DELETE RESTRICT,
        ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

- 일반 칼럼을 정의
- 외래키 제약조건 정의 


### 외래키 코드 분석

```sql
    CONSTRAINT fk_orders_user
        FOREIGN KEY (user_id),
        REFERENCES users(user_id),
        ON DELETE RESTRICT,
        ON UPDATE CASCADE
```

#### CONSTRAAINT - 제약조건 이름 지정

```sql
CONSTRAINT fk_orders_user
```

해당 외래키 제약조건의 이름을 **fk_orders_user** 로 지정한다는 의미입니다. 다음과 같은 이유로 지정합니다.

- 나중에 제약조건을 삭제하거나 수정할 때 이름으로 참조
- 에러 메시지에서 어떤 제약조건인지 쉽게 알 수 있음

명명규칙은 다음과 같습니다.

```sql
fk_자식테이블명_부모테이블명
```

### FOREIGN KEY - 외래키 칼럼 지정

```sql
FOREIGN KEY (user_id)
```

현재 테이블 (orders) 의 user_id 칼럼이 외래키임을 선언합니다. 

### REFERENCES - 참조 대상 지정

```sql
REFERENCES users(user_id)
```

users 테이블의 user_id 칼럼을 참조합니다. 참고로 참조 가능하기 위해서는 다음과 같은 조건을 만족해야 합니다.

- 반드시 PRIMARY KEY 또는 UNIQUE KEY 

이는 외래키는 부모의 유일한 레코드를 가리켜야 하기 때문입니다.

### ON DELETED - 부모 삭제 시 동작 정의

```sql
ON DELETED RESTRICT
```

부모 테이블의 레코드가 삭제될 때 자식 테이블을 어떻게 처리할지 지정하는 것 입니다.
이 부분이 외래키의 핵심이며 어떤 옵션들이 있는지 살펴보겠습니다.

#### RESTRICT (제한)

```sql
ON DELETED RESTRICT
```

- 자식 레코드가 존재하면 부모 테이블을 삭제할 수 없습니다.
- 다음과 같은 경우 사용합니다.
    - 중요한 데이터
    - 이력이 보존되어야 하는 경우
    - 주문 내역이 있는 회원은 삭제 불가

#### CASCADE (연쇄)

```sql
ON DELETED CASCADE
```

- 부모 레코드가 삭제되면 자식 레코드도 자동으로 함께 삭제됩니다.
- 다음과 같은 경우 사용합니다.
    - 종속적인 데이터
    - 임시 데이터
    - 부모가 없으면 의미 없는 데이터

#### SET NULL (NULL 로 설정)

```sql
ON DELETED SET NULL
```

- 부모 레코드가 삭제되면 자식의 외래키를 NULL 로 변경합니다.
- 다음과 같은 경우 사용합니다.
    - 선택적 참조
    - 부모가 삭제되어도 자식은 유지해야 할 때


#### SET DEFAULT (기본값으로 설정)

```sql
ON DELETED SET DEFAULT
```

- 부모 레코드가 삭제되면 자식의 외래키를 DEFAULT 로 변경합니다.
- 다음과 같은 경우 사용합니다.
    - MySQL InnoDB 에서는 지원하지 않습니다.
    - PostgreSQL 등 다른 DBMS 에서는 지원합니다.


### ON UPDATE - 부모 업데이트 시 동작 정의

```sql
ON UPDATE CASCADE
```

부모 테이블의 PRIMARY KEY 가 변경될 때 자식 테이블을 어떻게 처리할지를 결정하는 부분입니다.

옵션은 다음과 같습니다.
- CASCADE
- RESTRICT
- SET NULL
- SET DEFAULT

